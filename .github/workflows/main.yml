name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main  # Cambia esto si usas otra rama

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # Paso 1: Checkout del repositorio
    - name: Checkout repository
      uses: actions/checkout@v2

    # Paso 2: Configuración de la clave SSH
    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 159.223.134.151 >> ~/.ssh/known_hosts
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

    # Paso 3: Verificación de la conexión SSH
    - name: Test SSH connection
      run: |
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no altitude@159.223.134.151 "echo Conexión exitosa"
      
    # Paso 4: Verificar que el usuario correcto está siendo utilizado en el servidor
    - name: Verify user on server
      run: |
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no altitude@159.223.134.151 "whoami"
      
    # Paso 5: Desplegar o ejecutar el código que necesites en el servidor (esto depende de tu aplicación)
    - name: Deploy application
      run: |
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no altitude@159.223.134.151 "cd /ruta/del/proyecto && git pull && ./deploy.sh"
